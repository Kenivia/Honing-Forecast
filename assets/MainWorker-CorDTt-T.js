(function(){"use strict";function P(e){let t=Array.from({length:2},()=>new Array(e[0].length).fill(0));for(let a=0;a<e[0].length;a++)t[0][a]=(e[0][a]?1:0)+(e[1][a]?1:0)+(e[2][a]?1:0)+(e[3][a]?1:0)+(e[4][a]?1:0),t[1][a]=e[5][a]?1:0;return t}function H(e){let t=e.length;for(;t!=0;){let a=Math.floor(Math.random()*t);t--,[e[t],e[a]]=[e[a],e[t]]}}function k(e){if(!e)throw"Assertion failed"}function J(e,t,a,l=1){for(var n=Math.min(e.length,t.length),s=n;s--;)e[s]=Number(e[s])+Number(t[s][a])*l;return e}function te(e){e*=100;let t=0;for(;;){if(e>=1/10**t)return e.toFixed(t);if(t>=4)return"0";t++}}function R(e,t){const a=e.length,l=t.length;if(a===0||l===0)return new Array(l).fill(0);const n=new Uint32Array(l);for(let s=0;s<a;s++){const r=e[s],c=r[0],m=r[1],_=r[2],h=r[3],g=r[4],A=r[5],d=r[6];for(let y=0;y<l;y++){const f=t[y];(c>f[0]||m>f[1]||_>f[2]||h>f[3]||g>f[4]||A>f[5]||d>f[6])&&n[y]++}}return Array.from(n)}function re(e,t,a,l=null,n=null){let s=0,r=0;for(const[c,m]of t.entries())for(const[_,h]of m.entries())c==0&&(s+=e[1][_]*h),c==1&&(r+=e[1][_]*h);for(const[c,m]of a.entries())for(const[_,h]of m.entries())c==0&&(s+=e[0][_]*h),c==1&&(r+=e[0][_]*h);if(Array.isArray(n))for(const[c,m]of n.entries())for(const[_,h]of m.entries())_%2==1&&(c==0&&(s+=l[0][Math.floor((_-1)/2)]*h),c==1&&(r+=l[0][Math.floor((_-1)/2)]*h)),_%2==0&&(c==0&&(s+=l[1][Math.floor(_/2)]*h),c==1&&(r+=l[1][Math.floor(_/2)]*h));return[s,r]}function ne(e,t=1,a=0,l=0){let n=[],s=0,r=e,c=0;for(;;){if(l<=0&&(a=0),r=e+Math.min(c,10)*e/10+a,l-=1,s>=1){r=1,n[c]=r;break}n[c]=r,c+=1,s+=46.51/100*r*t}return n}function oe(e){let t=new Array(e.length),a=1;for(const[l,n]of e.entries())t[l]=a*n,a*=1-n;return t}function K(e,t,a,l,n,s,r,c,m,_,h){k(e.length==2),k(e[0].length==e[1].length),k(Math.max(...e[0])<=5),k(Math.min(...e[0])>=0),k(Math.max(...e[1])<=1),k(Math.min(...e[1])>=0);for(const o of e[0])k(Number.isInteger(o));for(const o of e[1])k(Number.isInteger(o));k(Math.max(...n[0])<=5),k(Math.min(...n[0])>=0),k(Math.max(...n[1])<=1),k(Math.min(...n[1])>=0);for(const o of n[0])k(Number.isInteger(o));for(const o of n[1])k(Number.isInteger(o));let g=t;for(const o of g)k(0<o<=1);k(h=="Juice on grace"||h=="No juice");let A=[],d=[],y=Array.from({length:a.length},()=>new Array);for(let o=0;o<e.length;o++){let p=o==0?l:a,i=0;for(let u=0;u<e[o].length;){if(i>=e[o][u]){u++,i=0;continue}A.push("Normal"+(o==0?" Armor ":" Weapon ")+" +"+u.toString());let j=g[u],v=ne(j),I=oe(v);for(const b of[...Array(a.length).keys()])y[b].push(p[b][u]);d.push(I),i++}}let f=[],w=[];for(let o=0;o<n.length;o++){let p=0;for(let i=0;i<n[o].length;){if(p>=n[o][i]){i++,p=0;continue}A.push("Adv"+(o==0?" Armor ":" Weapon ")+" +"+(i*10).toString());let u;h=="Juice on grace"?u=i<=1?r:c:u=i<=1?m:_;let j=Array(u.length).fill(0),v=u.map(b=>b[2]).reduce((b,x)=>b+x,0),I=Array.from({length:9},()=>new Array(j.length).fill(0));for(let b=0;b<j.length;b++){j[b]=u[b][2]/v;for(let x=0;x<7;x++)I[x][b]=s[x][2*i+(1-o)]*u[b][0];for(let x=7;x<9;x++)I[x][b]=s[x][2*i+(1-o)]*u[b][1]*(h=="Juice on grace"?1:0)}w.push(j),f.push(I),p++}}return w.length==0&&(w=[[0]]),f.length==0&&(f=[[[0],[0],[0],[0],[0],[0],[0],[0],[0]]]),[d,y,w,f,A]}function ae(e){if(!e||e.length===0)return new Uint32Array(0);const t=e.length,a=e[0].length;for(let s=1;s<t;s++)if(e[s].length!==a)throw new Error("All rows must have the same length");const l=new Uint32Array(t*a);let n=0;for(let s=0;s<t;s++)l.set(e[s],n),n+=a;return l}function le(e,t,a={zeroCopy:!0}){const l=a.zeroCopy!==void 0?a.zeroCopy:!0;if(!Number.isInteger(t)||t<0)throw new Error("n must be a non-negative integer");if(t===0)return[];if(e instanceof Uint32Array||(e=new Uint32Array(e)),e.length%t!==0)throw new Error("flat.length must be divisible by n");const n=e.length/t,s=new Array(t);if(l)for(let r=0;r<t;r++)s[r]=e.subarray(r*n,(r+1)*n);else for(let r=0;r<t;r++){const c=new Uint32Array(n);c.set(e.subarray(r*n,(r+1)*n)),s[r]=c}return s}function Q(e="my-cache-db",t=1){return new Promise((a,l)=>{const n=indexedDB.open(e,t);n.onupgradeneeded=s=>{const r=s.target.result;r.objectStoreNames.contains("computed")||r.createObjectStore("computed",{keyPath:"key"})},n.onsuccess=()=>a(n.result),n.onerror=()=>l(n.error)})}async function se(e,t,a={},l="my-cache-db"){const n=await Q(l);return new Promise((s,r)=>{const m=n.transaction("computed","readwrite").objectStore("computed"),_=new Blob([t.buffer],{type:"application/octet-stream"}),h={key:e,dtype:t.constructor.name,length:t.length,meta:a,blob:_},g=m.put(h);g.onsuccess=()=>s(!0),g.onerror=()=>r(g.error)})}async function ie(e,t="my-cache-db"){const a=await Q(t);return new Promise((l,n)=>{const c=a.transaction("computed","readonly").objectStore("computed").get(e);c.onsuccess=async()=>{const m=c.result;if(!m)return l(null);const _=m.blob;try{const h=await _.arrayBuffer();let g;switch(m.dtype){case"Float32Array":g=new Float32Array(h);break;case"Float64Array":g=new Float64Array(h);break;case"Int16Array":g=new Int16Array(h);break;case"UInt32Array":g=new Uint32Array(h);break;default:g=new Uint32Array(h)}l({arr:g,meta:m.meta})}catch(h){n(h)}},c.onerror=()=>n(c.error)})}function ce(e,t,a,l,n,s,r,c,m,_,h,g,A,d){let y=Array.from({length:l},()=>new Uint32Array(7).fill(0)),f=e[d].map((i=>u=>i+=u)(0));f[f.length-1]=1;let w=Array(l).fill(0),o=0,p=0;for(let i=0;i<f.length;i++)for(o=Math.max(o,f[i]*l),o=o-Math.floor(o)>Math.random()?Math.floor(o)+1:Math.floor(o);p<o;p++)w[p]=i+1;for(let i=0;i<7;i++)for(let u=1;u<=l;u++)g?y[u-1][i]=t[i][d]*Math.ceil(u/l*e[d].length):y[u-1][i]=t[i][d]*Math.ceil(w[u]);return A&&H(y),y}function fe(e,t,a,l,n,s,r,c,m,_,h,g,A,d){let y=Array.from({length:l},()=>new Uint32Array(9).fill(0)),f=m[d].map((i=>u=>i+=u)(0));f[f.length-1]=1;let w=Array(l).fill(0),o=0,p=0;for(let i=0;i<f.length;i++)for(o=Math.max(o,f[i]*l),o=o-Math.floor(o)>Math.random()?Math.floor(o)+1:Math.floor(o);p<o;p++)w[p]=i;for(let i=0;i<9;i++)for(let u=0;u<l;u++)g?y[u][i]=_[d][i][Math.ceil((u+1)/l*_[d][i].length)-1]:y[u][i]=_[d][i][w[u]];return A&&H(y),y}async function V(e,t,a,l,n,s,r,c,m,_,h,g,A,d,y){const f=e+A[y+(e=="Adv"?t.length:0)]+d.toString()+n.toString(),w=await ie(f);if(w==null){let o;if(e=="Normal")o=ce(t,a,l,n,s,r,c,m,_,h,g,d,!d,y);else if(e=="Adv")o=fe(t,a,l,n,s,r,c,m,_,h,g,d,!d,y);else throw new Error("Invalid hone type "+e);return se(f,ae(o)),o}else return le(w.arr,n)}async function X(e,t,a,l,n,s,r,c,m,_,h,g,A=!1){let d=Array.from({length:l},()=>new Uint32Array(9).fill(0));for(let f=0;f<e.length;f++){let w=await V("Normal",e,t,a,l,n,s,r,c,m,_,h,g,A,f);for(let o=0;o<w.length;o++)for(let p=0;p<w[0].length;p++)d[o][p]+=w[o][p]}for(let f=0;f<m.length;f++){let w=await V("Adv",e,t,a,l,n,s,r,c,m,_,h,g,A,f);for(let o=0;o<w.length;o++)for(let p=0;p<w[0].length;p++)d[o][p]+=w[o][p]}let y=re(n,s,r,c,h);for(let f=0;f<d.length;f++)d[f][3]+=y[0],d[f][6]+=y[1];return d}async function Y(e,t,a,l,n,s,r,c,m,_,h,g,A,d){const y=await X(l,n,s,e,r,c,m,_,h,g,A,d);if(t>0){const f=await X(l,n,s,t,r,c,m,_,h,g,A,d,!0);return[y,f]}else return[y,[]]}async function he(e,t,a,l,n,s,r,c,m,_,h,g,A,d,y,f,w){let[o,p,i,u,j]=K(e,t,a,l,_,h,A,d,y,f,w),[v,I]=await Y(1e5,0,1e3,o,p,m,e,n,s,_,i,u,g,j),b=Array(r[0].length).fill(0),x=[];for(let F of[...Array(r[0].length).keys()])x[F]=Array(r.length).fill(0);for(let F of v)for(let[N,D]of r[0].entries()){let S=!1;for(let z of[...Array(r.length).keys()])r[z][N]<F[z]&&(S=!0,x[N][z]++);S||(b[N]+=1/v.length)}let E=[];for(let[F,N]of x.entries()){let D=[...Array(N.length).keys()].sort((T,U)=>N[U]-N[T]),S=[],z=!1;for(let T of D){let U=te(N[T]/v.length);(U>=.1||!z)&&S.push(c[T]+"("+U.toString()+"%)"),z=!0}Math.max(...N)==0?E.push("None"):E.push(S.join(", "))}return[b,E]}async function ue(e,t,a,l,n,s,r,c,m,_,h,g,A,d,y,f){let[i,u,j,v,I]=K(e,t,a,l,m,_,g,A,d,y,f),[b,x]=await Y(5e4,1e3,1e3,i,u,r,e,n,s,m,j,v,h,I),E=R(b,x);const F=b.length,N=Math.floor((1-c)*F),D=b[0].length,S=E.map(M=>Math.abs(M-N)),z=S.map((M,C)=>C).sort((M,C)=>S[M]===S[C]?M-C:S[M]-S[C]),T=x[z[0]];let U=[T];for(let M=0;M<i.length;M++){let C=T.slice(),O=T.slice(),q=[Array(i.length).keys()];q.splice(M,1),J(C,u,M),J(O,u,M,-1),U.push(C.slice()),U.push(O.slice());for(let ee=1;ee<i.length-1;ee++){let G=Math.floor(Math.random()*q.length);J(C,u,G),J(O,u,G,-1),q.splice(G,1),U.push(C.slice()),U.push(O.slice())}}let Z=R(b,U);const B=Z.map(M=>Math.abs(M-N)),$=B.map((M,C)=>C).sort((M,C)=>B[M]===B[C]?M-C:B[M]-B[C]);let L=Array(D+1).fill(0);for(let M=0;M<D;M++)L[M]+=U[$[0]][M];return L[D]=((1-Z[$[0]]/b.length)*100).toFixed(4),L}const W=["Red","Blue","Leaps","Shards","Oreha","Gold","Silver(WIP)"];async function _e(e){const t=e.normal_hone_ticks,a=e.adv_hone_ticks,l=e.budget,s=await(await fetch("/Honing-forecast/data.json")).text(),{normal_hone_chances:r,normal_hone_weapon_cost:c,normal_hone_armor_cost:m,normal_hone_weapon_unlock:_,normal_hone_armor_unlock:h,adv_hone_cost:g,adv_hone_unlock:A,adv_data_10_20_juice:d,adv_data_30_40_juice:y,adv_data_10_20:f,adv_data_30_40:w}=JSON.parse(s),[o,p]=await he(P(t),r,c,m,_,h,Array.from(W,j=>[l[j]]),W,10,P(a),g,A,d,y,f,w,"No juice");let i=(o[0]*100).toFixed(2),u=p[0];return{chance:i,reason:u}}async function me(e){const t=e.normal_hone_ticks,a=e.adv_hone_ticks,l=e.desired_chance,n=e.adv_hone_strategy,r=await(await fetch("/Honing-forecast/data.json")).text(),{normal_hone_chances:c,normal_hone_weapon_cost:m,normal_hone_armor_cost:_,normal_hone_weapon_unlock:h,normal_hone_armor_unlock:g,adv_hone_cost:A,adv_hone_unlock:d,adv_data_10_20_juice:y,adv_data_30_40_juice:f,adv_data_10_20:w,adv_data_30_40:o}=JSON.parse(r),p=await ue(P(t),c,m,_,h,g,10,l/100,P(a),A,d,y,f,w,o,n),i=W.concat(["Red juice","Blue juice","Est. Probability"]);return Object.fromEntries(i.map((u,j)=>[u,p[j]]))}self.addEventListener("message",async e=>{const t=e.data;let a=Date.now();const{id:l,payload:n,which_one:s}=t;k(s=="CostToChance"||s=="ChanceToCost");let r;s=="CostToChance"?r=await _e(n):s=="ChanceToCost"&&(r=await me(n)),r.run_time=((Date.now()-a)/1e3).toFixed(2),self.postMessage({type:"result",id:l,result:r})})})();
