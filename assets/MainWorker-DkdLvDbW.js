(function(){"use strict";const W=["Red","Blue","Leaps","Shards","Oreha","Gold","Silver(WIP)"];function P(e){let t=Array.from({length:2},()=>new Array(e[0].length).fill(0));for(let r=0;r<e[0].length;r++)t[0][r]=(e[0][r]?1:0)+(e[1][r]?1:0)+(e[2][r]?1:0)+(e[3][r]?1:0)+(e[4][r]?1:0),t[1][r]=e[5][r]?1:0;return t}function L(e){let t=e.length;for(;t!=0;){let r=Math.floor(Math.random()*t);t--,[e[t],e[r]]=[e[r],e[t]]}}function M(e){if(!e)throw"Assertion failed"}function z(e,t,r,c=1){for(var s=Math.min(e.length,t.length),o=s;o--;)e[o]=Number(e[o])+Number(t[o][r])*c;return e}function re(e){e*=100;let t=0;for(;;){if(e>=1/10**t)return e.toFixed(t);if(t>=4)return"0";t++}}function ne(e,t,r,c=null,s=null){let o=0,n=0;for(const[l,h]of t.entries())for(const[f,i]of h.entries())l==0&&(o+=e[1][f]*i),l==1&&(n+=e[1][f]*i);for(const[l,h]of r.entries())for(const[f,i]of h.entries())l==0&&(o+=e[0][f]*i),l==1&&(n+=e[0][f]*i);if(Array.isArray(s))for(const[l,h]of s.entries())for(const[f,i]of h.entries())f%2==1&&(l==0&&(o+=c[0][Math.floor((f-1)/2)]*i),l==1&&(n+=c[0][Math.floor((f-1)/2)]*i)),f%2==0&&(l==0&&(o+=c[1][Math.floor(f/2)]*i),l==1&&(n+=c[1][Math.floor(f/2)]*i));return[o,n]}function oe(e,t=1,r=0,c=0){let s=[],o=0,n=e,l=0;for(;;){if(c<=0&&(r=0),n=e+Math.min(l,10)*e/10+r,c-=1,o>=1){n=1,s[l]=n;break}s[l]=n,l+=1,o+=46.51/100*n*t}return s}function ae(e){let t=new Array(e.length),r=1;for(const[c,s]of e.entries())t[c]=r*s,r*=1-s;return t}function K(e,t,r,c,s,o,n,l,h,f,i){M(e.length==2),M(e[0].length==e[1].length),M(Math.max(...e[0])<=5),M(Math.min(...e[0])>=0),M(Math.max(...e[1])<=1),M(Math.min(...e[1])>=0);for(const u of e[0])M(Number.isInteger(u));for(const u of e[1])M(Number.isInteger(u));M(Math.max(...s[0])<=5),M(Math.min(...s[0])>=0),M(Math.max(...s[1])<=1),M(Math.min(...s[1])>=0);for(const u of s[0])M(Number.isInteger(u));for(const u of s[1])M(Number.isInteger(u));let a=t;for(const u of a)M(0<u&&u<=1);M(i=="Juice on grace"||i=="No juice");let y=[],k=[],g=Array.from({length:r.length},()=>new Array);for(let u=0;u<e.length;u++){let b=u==0?c:r,d=0;for(let _=0;_<e[u].length;){if(d>=e[u][_]){_++,d=0;continue}y.push("Normal"+(u==0?" Armor ":" Weapon ")+" +"+_.toString()+"#"+d.toString());let C=a[_],v=oe(C),S=ae(v);for(const p of[...Array(r.length).keys()])g[p].push(b[p][_]);k.push(S),d++}}let m=[],w=[];for(let u=0;u<s.length;u++){let b=0;for(let d=0;d<s[u].length;){if(b>=s[u][d]){d++,b=0;continue}y.push("Adv"+(u==0?" Armor ":" Weapon ")+" +"+(d*10).toString()+i+"#"+b.toString());let _;i=="Juice on grace"?_=d<=1?n:l:_=d<=1?h:f;let C=Array(_.length).fill(0),v=_.map(p=>p[2]).reduce((p,x)=>p+x,0),S=Array.from({length:9},()=>new Array(C.length).fill(0));for(let p=0;p<C.length;p++){C[p]=_[p][2]/v;for(let x=0;x<7;x++)S[x][p]=o[x][2*d+(1-u)]*_[p][0];for(let x=7;x<9;x++)S[x][p]=o[x][2*d+(1-u)]*_[p][1]*(i=="Juice on grace"?1:0)}w.push(C),m.push(S),b++}}return w.length==0&&(w=[]),m.length==0&&(m=[]),[k,g,w,m,y]}function le(e){if(!e||e.length===0)return new Uint32Array(0);const t=e.length,r=e[0].length;for(let o=1;o<t;o++)if(e[o].length!==r)throw new Error("All rows must have the same length");const c=new Uint32Array(t*r);let s=0;for(let o=0;o<t;o++)c.set(e[o],s),s+=r;return c}function se(e,t,r={zeroCopy:!0}){const c=r.zeroCopy!==void 0?r.zeroCopy:!0;if(!Number.isInteger(t)||t<0)throw new Error("n must be a non-negative integer");if(t===0)return[];const s=e instanceof Uint32Array?e:new Uint32Array(e);if(s.length%t!==0)throw new Error("flat.length must be divisible by n");const o=s.length/t,n=new Array(t);if(c)for(let l=0;l<t;l++)n[l]=s.subarray(l*o,(l+1)*o);else for(let l=0;l<t;l++){const h=new Uint32Array(o);h.set(s.subarray(l*o,(l+1)*o)),n[l]=h}return n}function Q(e="my-cache-db",t=1){return new Promise((r,c)=>{const s=indexedDB.open(e,t);s.onupgradeneeded=o=>{const n=o.target.result;n.objectStoreNames.contains("computed")||n.createObjectStore("computed",{keyPath:"key"})},s.onsuccess=()=>r(s.result),s.onerror=()=>c(s.error)})}async function ie(e,t,r={},c="my-cache-db"){const s=await Q(c);return new Promise((o,n)=>{const h=s.transaction("computed","readwrite").objectStore("computed"),f=new Blob([t.buffer],{type:"application/octet-stream"}),i={key:e,dtype:t.constructor.name,length:t.length,meta:r,blob:f},a=h.put(i);a.onsuccess=()=>o(!0),a.onerror=()=>n(a.error)})}async function ce(e,t="my-cache-db"){const r=await Q(t);return new Promise((c,s)=>{const l=r.transaction("computed","readonly").objectStore("computed").get(e);l.onsuccess=async()=>{const h=l.result;if(!h)return c(null);const f=h.blob;try{const i=await f.arrayBuffer();let a;switch(h.dtype){case"Float32Array":a=new Float32Array(i);break;case"Float64Array":a=new Float64Array(i);break;case"Int16Array":a=new Int16Array(i);break;case"Int32Array":a=new Int32Array(i);break;case"Int8Array":a=new Int8Array(i);break;case"Uint8Array":a=new Uint8Array(i);break;case"Uint16Array":a=new Uint16Array(i);break;case"Uint32Array":a=new Uint32Array(i);break;case"Uint8ClampedArray":a=new Uint8ClampedArray(i);break;default:a=new Uint32Array(i)}c({arr:a,meta:h.meta})}catch(i){s(i)}},l.onerror=()=>s(l.error)})}function fe(e,t,r,c,s,o){let n=Array.from({length:r},()=>new Uint32Array(7).fill(0)),l=e[o].map((a=>y=>a+=y)(0));l[l.length-1]=1;let h=Array(r).fill(0),f=0,i=0;for(let a=0;a<l.length;a++)for(f=Math.max(f,l[a]*r),f=f-Math.floor(f)>Math.random()?Math.floor(f)+1:Math.floor(f);i<f;i++)h[i]=a+1;for(let a=0;a<7;a++)for(let y=1;y<=r;y++)c?n[y-1][a]=t[a][o]*Math.ceil(y/r*e[o].length):n[y-1][a]=t[a][o]*Math.ceil(h[y]);return s&&L(n),n}function he(e,t,r,c,s,o){let n=Array.from({length:e},()=>new Uint32Array(9).fill(0)),l=t[o].map((a=>y=>a+=y)(0));l[l.length-1]=1;let h=Array(e).fill(0),f=0,i=0;for(let a=0;a<l.length;a++)for(f=Math.max(f,l[a]*e),f=f-Math.floor(f)>Math.random()?Math.floor(f)+1:Math.floor(f);i<f;i++)h[i]=a;for(let a=0;a<9;a++)for(let y=0;y<e;y++)c?n[y][a]=r[o][a][Math.ceil((y+1)/e*r[o][a].length)-1]:n[y][a]=r[o][a][h[y]];return s&&L(n),n}async function V(e,t,r,c,s,o,n,l,h){const f=e+n[h+(e=="Adv"?t.length:0)]+l.toString()+c.toString();let i=null;if(typeof indexedDB<"u"&&(i=await ce(f)),i==null){let a;if(e=="Normal")a=fe(t,r,c,l,!l,h);else if(e=="Adv")a=he(c,s,o,l,!l,h);else throw new Error("Invalid hone type "+e);return typeof indexedDB<"u"&&ie(f,le(a)),a}else return se(i.arr,c)}async function X(e,t,r,c,s,o,n,l,h,f,i,a=!1){let y=Array.from({length:r},()=>new Uint32Array(9).fill(0));for(let g=0;g<e.length;g++){let m=await V("Normal",e,t,r,l,h,i,a,g);for(let w=0;w<m.length;w++)for(let u=0;u<m[0].length;u++)y[w][u]+=m[w][u]}for(let g=0;g<l.length;g++){let m=await V("Adv",e,t,r,l,h,i,a,g);for(let w=0;w<m.length;w++)for(let u=0;u<m[0].length;u++)y[w][u]+=m[w][u]}let k=ne(c,s,o,n,f);for(let g=0;g<y.length;g++)y[g][3]+=k[0],y[g][6]+=k[1];return y}async function Y(e,t,r,c,s,o,n,l,h,f,i,a){const y=await X(r,c,e,s,o,n,l,h,f,i,a);if(t>0){const k=await X(r,c,t,s,o,n,l,h,f,i,a,!0);return[y,k]}else return[y,[]]}async function ue(e,t,r,c,s,o,n,l,h,f,i,a,y,k,g,m){let[w,u,b,d,_]=K(e,t,r,c,h,f,a,y,k,g,m),[C,v]=await Y(1e5,0,w,u,e,s,o,h,b,d,i,_),S=Array(n[0].length).fill(0),p=[];for(let T of[...Array(n[0].length).keys()])p[T]=Array(n.length).fill(0);for(let T of C)for(let[U,B]of n[0].entries()){let j=!1;for(let I of[...Array(n.length).keys()])n[I][U]<T[I]&&(j=!0,p[U][I]++);j||(S[U]+=1/C.length)}let x=[];for(let[T,U]of p.entries()){let B=[...Array(U.length).keys()].sort((D,F)=>U[F]-U[D]),j=[],I=!1;for(let D of B){let F=re(U[D]/C.length);(Number(F)>=.1||!I)&&j.push(l[D]+"("+F.toString()+"%)"),I=!0}Math.max(...U)==0?x.push("None"):x.push(j.join(`
`))}return[S,x]}function ye(e,t){return e[0]<=t[0]&&e[1]<=t[1]&&e[2]<=t[2]&&e[3]<=t[3]&&e[4]<=t[4]&&e[5]<=t[5]&&e[6]<=t[6]}function me(e,t){const r=e.length,c=t.length;if(r===0||c===0)return new Array(c).fill(0);const s=new Int32Array(c+1);for(let n=0;n<r;n++){const l=e[n];let h=0,f=c-1,i=c;for(;h<=f;){const a=h+(f-h>>1);ye(l,t[a])?(i=a,f=a-1):h=a+1}i>0&&(s[0]++,s[i]--)}const o=new Uint32Array(c);o[0]=s[0];for(let n=1;n<c;n++)o[n]=o[n-1]+s[n];return Array.from(o)}function Z(e,t,r=!1){return r?me(e,t):ge(e,t)}function ge(e,t){const r=e.length,c=t.length;if(r===0||c===0)return new Array(c).fill(0);const s=new Uint32Array(c);for(let o=0;o<r;o++){const n=e[o],l=n[0],h=n[1],f=n[2],i=n[3],a=n[4],y=n[5],k=n[6];for(let g=0;g<c;g++){const m=t[g];(l>m[0]||h>m[1]||f>m[2]||i>m[3]||a>m[4]||y>m[5]||k>m[6])&&s[g]++}}return Array.from(s)}async function de(e,t,r,c,s,o,n,l,h,f,i,a,y,k,g){console.log("start");const m=Date.now(),w=5e4,u=1e4;let[b,d,_,C,v]=K(e,t,r,c,l,h,i,a,y,k,g);console.log("parser done: "+((Date.now()-m)/1e3).toString());let[S,p]=await Y(w,u,b,d,e,s,o,l,_,C,f,v);console.log("Monte carlos done: "+((Date.now()-m)/1e3).toString());let x=Z(S,p,!0);console.log("Failure count 1 done: "+((Date.now()-m)/1e3).toString());const T=S.length,U=Math.floor((1-n)*T),B=S[0].length,j=x.map(A=>Math.abs(A-U)),I=j.map((A,N)=>N).sort((A,N)=>j[A]===j[N]?A-N:j[A]-j[N]),D=p[I[0]];let F=[D],q=Array.from(Array(b.length+_.length).keys());L(q);let J=0;for(let A=0;A<Math.max(1,Math.min(q.length,Math.floor(1e3/(b.length+_.length))));A++){J=q[A];let N=D.slice(),O=D.slice(),R=[Array(b.length).keys()];R.splice(J,1),z(N,d,J),z(O,d,J,-1),F.push(N.slice()),F.push(O.slice());for(let te=1;te<b.length-1;te++){let G=Math.floor(Math.random()*R.length);z(N,d,G),z(O,d,G,-1),R.splice(G,1),F.push(N.slice()),F.push(O.slice())}}let $=Z(S,F);console.log("Failure 2 done: "+((Date.now()-m)/1e3).toString());const E=$.map(A=>Math.abs(A-U)),ee=E.map((A,N)=>N).sort((A,N)=>E[A]===E[N]?A-N:E[A]-E[N]);let H=Array(B+1).fill(0);for(let A=0;A<B;A++)H[A]+=F[ee[0]][A];return H[B]=((1-$[ee[0]]/S.length)*100).toFixed(4),console.log("Finish: "+((Date.now()-m)/1e3).toString()),H}async function _e(e){const t=e.normal_hone_ticks,r=e.adv_hone_ticks,c=e.budget,o=await(await fetch("/Honing-Forecast/data.json")).text(),{normal_hone_chances:n,normal_hone_weapon_cost:l,normal_hone_armor_cost:h,normal_hone_weapon_unlock:f,normal_hone_armor_unlock:i,adv_hone_cost:a,adv_hone_unlock:y,adv_data_10_20_juice:k,adv_data_30_40_juice:g,adv_data_10_20:m,adv_data_30_40:w}=JSON.parse(o),[u,b]=await ue(P(t),n,l,h,f,i,Array.from(W,C=>[Number(c[C])]),W,P(r),a,y,k,g,m,w,"No juice");let d=(u[0]*100).toFixed(2),_=b[0];return{chance:d,reason:_}}async function we(e){const t=e.normal_hone_ticks,r=e.adv_hone_ticks,c=e.desired_chance,s=e.adv_hone_strategy,n=await(await fetch("/Honing-Forecast/data.json")).text(),{normal_hone_chances:l,normal_hone_weapon_cost:h,normal_hone_armor_cost:f,normal_hone_weapon_unlock:i,normal_hone_armor_unlock:a,adv_hone_cost:y,adv_hone_unlock:k,adv_data_10_20_juice:g,adv_data_30_40_juice:m,adv_data_10_20:w,adv_data_30_40:u}=JSON.parse(n),b=await de(P(t),l,h,f,i,a,Number(c)/100,P(r),y,k,g,m,w,u,s),d=W.concat(["Red juice","Blue juice","Est. Probability"]);return Object.fromEntries(d.map((_,C)=>[_,b[C]]))}self.addEventListener("message",async e=>{const t=e.data;let r=Date.now();const{id:c,payload:s,which_one:o}=t;M(o=="CostToChance"||o=="ChanceToCost");let n;o=="CostToChance"?n=await _e(s):o=="ChanceToCost"&&(n=await we(s)),n.run_time=((Date.now()-r)/1e3).toFixed(2),self.postMessage({type:"result",id:c,result:n})})})();
