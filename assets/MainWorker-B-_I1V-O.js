(function(){"use strict";function U(e){let n=Array.from({length:2},()=>new Array(e[0].length).fill(0));for(let l=0;l<e[0].length;l++)n[0][l]=(e[0][l]?1:0)+(e[1][l]?1:0)+(e[2][l]?1:0)+(e[3][l]?1:0)+(e[4][l]?1:0),n[1][l]=e[5][l]?1:0;return n}function R(e){let n=e.length;for(;n!=0;){let l=Math.floor(Math.random()*n);n--,[e[n],e[l]]=[e[l],e[n]]}}function k(e){if(!e)throw"Assertion failed"}function B(e,n,l,a=1){for(var s=Math.min(e.length,n.length),f=s;f--;)e[f]=Number(e[f])+Number(n[f][l])*a;return e}function Z(e){e*=100;let n=0;for(;;){if(e>=1/10**n)return e.toFixed(n);if(n>=4)return"0";n++}}function q(e,n){for(var l=e.length,a=n.length,s=new Array(a).fill(0),f=0;f<l;f++)for(var r=e[f],u=r[0],d=r[1],m=r[2],g=r[3],w=r[4],M=r[5],p=r[6],i=0;i<a;i++){var c=n[i],o=c[0],h=c[1],y=c[2],t=c[3],_=c[4],j=c[5],N=c[6];(u>o||d>h||m>y||g>t||w>_||M>j||p>N)&&s[i]++}return s}function $(e,n,l,a=null,s=null){let f=0,r=0;for(const[u,d]of n.entries())for(const[m,g]of d.entries())u==0&&(f+=e[1][m]*g),u==1&&(r+=e[1][m]*g);for(const[u,d]of l.entries())for(const[m,g]of d.entries())u==0&&(f+=e[0][m]*g),u==1&&(r+=e[0][m]*g);if(Array.isArray(s))for(const[u,d]of s.entries())for(const[m,g]of d.entries())m%2==1&&(u==0&&(f+=a[0][Math.floor((m-1)/2)]*g),u==1&&(r+=a[0][Math.floor((m-1)/2)]*g)),m%2==0&&(u==0&&(f+=a[1][Math.floor(m/2)]*g),u==1&&(r+=a[1][Math.floor(m/2)]*g));return[f,r]}function ee(e,n=1,l=0,a=0){let s=[],f=0,r=e,u=0;for(;;){if(a<=0&&(l=0),r=e+Math.min(u,10)*e/10+l,a-=1,f>=1){r=1,s[u]=r;break}s[u]=r,u+=1,f+=46.51/100*r*n}return s}function te(e){let n=new Array(e.length),l=1;for(const[a,s]of e.entries())n[a]=l*s,l*=1-s;return n}function K(e,n,l,a,s,f,r,u,d,m,g){k(e.length==2),k(e[0].length==e[1].length),k(Math.max(...e[0])<=5),k(Math.min(...e[0])>=0),k(Math.max(...e[1])<=1),k(Math.min(...e[1])>=0);for(const o of e[0])k(Number.isInteger(o));for(const o of e[1])k(Number.isInteger(o));k(Math.max(...s[0])<=5),k(Math.min(...s[0])>=0),k(Math.max(...s[1])<=1),k(Math.min(...s[1])>=0);for(const o of s[0])k(Number.isInteger(o));for(const o of s[1])k(Number.isInteger(o));let w=n;for(const o of w)k(0<o<=1);k(g=="Juice on grace"||g=="No juice");let M=[],p=Array.from({length:l.length},()=>new Array);for(let o=0;o<e.length;o++){let h=o==0?a:l,y=0;for(let t=0;t<e[o].length;){if(y>=e[o][t]){t++,y=0;continue}let _=w[t],j=ee(_),N=te(j);for(const x of[...Array(l.length).keys()])p[x].push(h[x][t]);M.push(N),y++}}let i=[],c=[];for(let o=0;o<s.length;o++){let h=0;for(let y=0;y<s[o].length;){if(h>=s[o][y]){y++,h=0;continue}let t;g=="Juice on grace"?t=y<=1?r:u:t=y<=1?d:m;let _=Array(t.length).fill(0),j=t.map(x=>x[2]).reduce((x,C)=>x+C,0),N=Array.from({length:9},()=>new Array(_.length).fill(0));for(let x=0;x<_.length;x++){_[x]=t[x][2]/j;for(let C=0;C<7;C++)N[C][x]=f[C][2*y+(1-o)]*t[x][0];for(let C=7;C<9;C++)N[C][x]=f[C][2*y+(1-o)]*t[x][1]*(g=="Juice on grace"?1:0)}c.push(_),i.push(N),h++}}return c.length==0&&(c=[[0]]),i.length==0&&(i=[[[0],[0],[0],[0],[0],[0],[0],[0],[0]]]),[M,p,c,i]}function ne(e,n,l,a,s,f,r,u,d,m,g,w,M,p){let i=Array.from({length:a},()=>new Uint32Array(7).fill(0)),c=e[p].map((t=>_=>t+=_)(0));c[c.length-1]=1;let o=Array(a).fill(0),h=0,y=0;for(let t=0;t<c.length;t++)for(h=Math.max(h,c[t]*a),h=h-Math.floor(h)>Math.random()?Math.floor(h)+1:Math.floor(h);y<h;y++)o[y]=t+1;for(let t=0;t<7;t++)for(let _=1;_<=a;_++)w?i[_-1][t]=n[t][p]*Math.ceil(_/a*e[p].length):i[_-1][t]=n[t][p]*Math.ceil(o[_]);return M&&R(i),i}function re(e,n,l,a,s,f,r,u,d,m,g,w,M,p){let i=Array.from({length:a},()=>new Uint32Array(9).fill(0)),c=d[p].map((t=>_=>t+=_)(0));c[c.length-1]=1;let o=Array(a).fill(0),h=0,y=0;for(let t=0;t<c.length;t++)for(h=Math.max(h,c[t]*a),h=h-Math.floor(h)>Math.random()?Math.floor(h)+1:Math.floor(h);y<h;y++)o[y]=t;for(let t=0;t<9;t++)for(let _=0;_<a;_++)w?i[_][t]=m[p][t][Math.ceil((_+1)/a*m[p][t].length)-1]:i[_][t]=m[p][t][o[_]];return M&&R(i),i}function Q(e,n,l,a,s,f,r,u,d,m,g,w=!1){let M=Array.from({length:a},()=>new Uint32Array(9).fill(0));for(let i=0;i<e.length;i++){let c=ne(e,n,l,a,s,f,r,u,d,m,g,w,!w,i);for(let o=0;o<c.length;o++)for(let h=0;h<c[0].length;h++)M[o][h]+=c[o][h]}for(let i=0;i<d.length;i++){let c=re(e,n,l,a,s,f,r,u,d,m,g,w,!w,i);for(let o=0;o<c.length;o++)for(let h=0;h<c[0].length;h++)M[o][h]+=c[o][h]}let p=$(s,f,r,u,g);for(let i=0;i<M.length;i++)M[i][3]+=p[0],M[i][6]+=p[1];return M}function V(e,n,l,a,s,f,r,u,d,m,g,w,M){const p=Q(a,s,f,e,r,u,d,m,g,w,M);if(n>0){const i=Q(a,s,f,n,r,u,d,m,g,w,M,!0);return[p,i]}else return[p,[]]}function oe(e,n,l,a,s,f,r,u,d,m,g,w,M,p,i,c,o,h=!1){let[y,t,_,j]=K(e,n,l,a,m,g,M,p,i,c,o),[N,x]=V(1e5,0,1e3,y,t,d,e,s,f,m,_,j,w),C=Array(r[0].length).fill(0),L=[];for(let I of[...Array(r[0].length).keys()])L[I]=Array(r.length).fill(0);for(let I of N)for(let[b,z]of r[0].entries()){let F=!1;for(let T of[...Array(r.length).keys()])r[T][b]<I[T]&&(F=!0,L[b][T]++);F||(C[b]+=1/N.length)}let E=[];for(let[I,b]of L.entries()){let z=[...Array(b.length).keys()].sort((S,J)=>b[J]-b[S]),F=[],T=!1;for(let S of z){let J=Z(b[S]/N.length);(J>=.1||!T)&&F.push(u[S]+"("+J.toString()+"%)"),T=!0}Math.max(...b)==0?E.push("None"):E.push(F.join(", "))}return[C,E]}function le(e,n,l,a,s,f,r,u,d,m,g,w,M,p,i,c){let[t,_,j,N]=K(e,n,l,a,d,m,w,M,p,i,c),[x,C]=V(5e4,1e3,1e3,t,_,r,e,s,f,d,j,N,g),L=q(x,C);const E=x.length,I=Math.floor((1-u)*E),b=x[0].length,z=L.map(A=>Math.abs(A-I)),F=z.map((A,v)=>v).sort((A,v)=>z[A]===z[v]?A-v:z[A]-z[v]),T=C[F[0]];let S=[T];for(let A=0;A<t.length;A++){let v=T.slice(),D=T.slice(),H=[Array(t.length).keys()];H.splice(A,1),B(v,_,A),B(D,_,A,-1),S.push(v.slice()),S.push(D.slice());for(let Y=1;Y<t.length-1;Y++){let P=Math.floor(Math.random()*H.length);B(v,_,P),B(D,_,P,-1),H.splice(P,1),S.push(v.slice()),S.push(D.slice())}}let J=q(x,S);const O=J.map(A=>Math.abs(A-I)),X=O.map((A,v)=>v).sort((A,v)=>O[A]===O[v]?A-v:O[A]-O[v]);let G=Array(b+1).fill(0);for(let A=0;A<b;A++)G[A]+=S[X[0]][A];return G[b]=((1-J[X[0]]/x.length)*100).toFixed(4),G}const W=["Red","Blue","Leaps","Shards","Oreha","Gold","Silver(WIP)"];async function ae(e){const n=e.normal_hone_ticks,l=e.adv_hone_ticks,a=e.budget,f=await(await fetch("/Honing-forecast/data.json")).text(),{normal_hone_chances:r,normal_hone_weapon_cost:u,normal_hone_armor_cost:d,normal_hone_weapon_unlock:m,normal_hone_armor_unlock:g,adv_hone_cost:w,adv_hone_unlock:M,adv_data_10_20_juice:p,adv_data_30_40_juice:i,adv_data_10_20:c,adv_data_30_40:o}=JSON.parse(f),[h,y]=oe(U(n),r,u,d,m,g,Array.from(W,j=>[a[j]]),W,10,U(l),w,M,p,i,c,o,"No juice",!0);let t=(h[0]*100).toFixed(2),_=y[0];return{chance:t,reason:_}}async function se(e){const n=e.normal_hone_ticks,l=e.adv_hone_ticks,a=e.desired_chance,s=e.adv_hone_strategy,r=await(await fetch("/Honing-forecast/data.json")).text(),{normal_hone_chances:u,normal_hone_weapon_cost:d,normal_hone_armor_cost:m,normal_hone_weapon_unlock:g,normal_hone_armor_unlock:w,adv_hone_cost:M,adv_hone_unlock:p,adv_data_10_20_juice:i,adv_data_30_40_juice:c,adv_data_10_20:o,adv_data_30_40:h}=JSON.parse(r),y=le(U(n),u,d,m,g,w,10,a/100,U(l),M,p,i,c,o,h,s),t=W.concat(["Red juice","Blue juice","Est. Probability"]);return Object.fromEntries(t.map((_,j)=>[_,y[j]]))}self.addEventListener("message",async e=>{const n=e.data;let l=Date.now();const{id:a,payload:s,which_one:f}=n;k(f=="CostToChance"||f=="ChanceToCost");let r;f=="CostToChance"?r=await ae(s):f=="ChanceToCost"&&(r=await se(s)),r.run_time=((Date.now()-l)/1e3).toFixed(2),self.postMessage({type:"result",id:a,result:r})})})();
