(function(){"use strict";const O=["Red","Blue","Leaps","Shards","Oreha","Gold","Silver(WIP)"];function E(e){let t=Array.from({length:2},()=>new Array(e[0].length).fill(0));for(let r=0;r<e[0].length;r++)t[0][r]=(e[0][r]?1:0)+(e[1][r]?1:0)+(e[2][r]?1:0)+(e[3][r]?1:0)+(e[4][r]?1:0),t[1][r]=e[5][r]?1:0;return t}function H(e){let t=e.length;for(;t!=0;){let r=Math.floor(Math.random()*t);t--,[e[t],e[r]]=[e[r],e[t]]}}function M(e){if(!e)throw"Assertion failed"}function P(e,t,r,c=1){for(var s=Math.min(e.length,t.length),o=s;o--;)e[o]=Number(e[o])+Number(t[o][r])*c;return e}function $(e){e*=100;let t=0;for(;;){if(e>=1/10**t)return e.toFixed(t);if(t>=4)return"0";t++}}function ee(e,t,r,c=null,s=null){let o=0,l=0;for(const[n,u]of t.entries())for(const[f,i]of u.entries())n==0&&(o+=e[1][f]*i),n==1&&(l+=e[1][f]*i);for(const[n,u]of r.entries())for(const[f,i]of u.entries())n==0&&(o+=e[0][f]*i),n==1&&(l+=e[0][f]*i);if(Array.isArray(s))for(const[n,u]of s.entries())for(const[f,i]of u.entries())f%2==1&&(n==0&&(o+=c[0][Math.floor((f-1)/2)]*i),n==1&&(l+=c[0][Math.floor((f-1)/2)]*i)),f%2==0&&(n==0&&(o+=c[1][Math.floor(f/2)]*i),n==1&&(l+=c[1][Math.floor(f/2)]*i));return[o,l]}function te(e,t=1,r=0,c=0){let s=[],o=0,l=e,n=0;for(;;){if(c<=0&&(r=0),l=e+Math.min(n,10)*e/10+r,c-=1,o>=1){l=1,s[n]=l;break}s[n]=l,n+=1,o+=46.51/100*l*t}return s}function re(e){let t=new Array(e.length),r=1;for(const[c,s]of e.entries())t[c]=r*s,r*=1-s;return t}function R(e,t,r,c,s,o,l,n,u,f,i){M(e.length==2),M(e[0].length==e[1].length),M(Math.max(...e[0])<=5),M(Math.min(...e[0])>=0),M(Math.max(...e[1])<=1),M(Math.min(...e[1])>=0);for(const h of e[0])M(Number.isInteger(h));for(const h of e[1])M(Number.isInteger(h));M(Math.max(...s[0])<=5),M(Math.min(...s[0])>=0),M(Math.max(...s[1])<=1),M(Math.min(...s[1])>=0);for(const h of s[0])M(Number.isInteger(h));for(const h of s[1])M(Number.isInteger(h));let a=t;for(const h of a)M(0<h&&h<=1);M(i=="Juice on grace"||i=="No juice");let d=[],k=[],m=Array.from({length:r.length},()=>new Array);for(let h=0;h<e.length;h++){let b=h==0?c:r,w=0;for(let g=0;g<e[h].length;){if(w>=e[h][g]){g++,w=0;continue}d.push("Normal"+(h==0?" Armor ":" Weapon ")+" +"+g.toString()+"#"+w.toString());let C=a[g],I=te(C),U=re(I);for(const A of[...Array(r.length).keys()])m[A].push(b[A][g]);k.push(U),w++}}let y=[],p=[];for(let h=0;h<s.length;h++){let b=0;for(let w=0;w<s[h].length;){if(b>=s[h][w]){w++,b=0;continue}d.push("Adv"+(h==0?" Armor ":" Weapon ")+" +"+(w*10).toString()+i+"#"+b.toString());let g;i=="Juice on grace"?g=w<=1?l:n:g=w<=1?u:f;let C=Array(g.length).fill(0),I=g.map(A=>A[2]).reduce((A,x)=>A+x,0),U=Array.from({length:9},()=>new Array(C.length).fill(0));for(let A=0;A<C.length;A++){C[A]=g[A][2]/I;for(let x=0;x<7;x++)U[x][A]=o[x][2*w+(1-h)]*g[A][0];for(let x=7;x<9;x++)U[x][A]=o[x][2*w+(1-h)]*g[A][1]*(i=="Juice on grace"?1:0)}p.push(C),y.push(U),b++}}return p.length==0&&(p=[]),y.length==0&&(y=[]),[k,m,p,y,d]}function ne(e){if(!e||e.length===0)return new Uint32Array(0);const t=e.length,r=e[0].length;for(let o=1;o<t;o++)if(e[o].length!==r)throw new Error("All rows must have the same length");const c=new Uint32Array(t*r);let s=0;for(let o=0;o<t;o++)c.set(e[o],s),s+=r;return c}function oe(e,t,r={zeroCopy:!0}){const c=r.zeroCopy!==void 0?r.zeroCopy:!0;if(!Number.isInteger(t)||t<0)throw new Error("n must be a non-negative integer");if(t===0)return[];const s=e instanceof Uint32Array?e:new Uint32Array(e);if(s.length%t!==0)throw new Error("flat.length must be divisible by n");const o=s.length/t,l=new Array(t);if(c)for(let n=0;n<t;n++)l[n]=s.subarray(n*o,(n+1)*o);else for(let n=0;n<t;n++){const u=new Uint32Array(o);u.set(s.subarray(n*o,(n+1)*o)),l[n]=u}return l}function G(e="my-cache-db",t=1){return new Promise((r,c)=>{const s=indexedDB.open(e,t);s.onupgradeneeded=o=>{const l=o.target.result;l.objectStoreNames.contains("computed")||l.createObjectStore("computed",{keyPath:"key"})},s.onsuccess=()=>r(s.result),s.onerror=()=>c(s.error)})}async function ae(e,t,r={},c="my-cache-db"){const s=await G(c);return new Promise((o,l)=>{const u=s.transaction("computed","readwrite").objectStore("computed"),f=new Blob([t.buffer],{type:"application/octet-stream"}),i={key:e,dtype:t.constructor.name,length:t.length,meta:r,blob:f},a=u.put(i);a.onsuccess=()=>o(!0),a.onerror=()=>l(a.error)})}async function le(e,t="my-cache-db"){const r=await G(t);return new Promise((c,s)=>{const n=r.transaction("computed","readonly").objectStore("computed").get(e);n.onsuccess=async()=>{const u=n.result;if(!u)return c(null);const f=u.blob;try{const i=await f.arrayBuffer();let a;switch(u.dtype){case"Float32Array":a=new Float32Array(i);break;case"Float64Array":a=new Float64Array(i);break;case"Int16Array":a=new Int16Array(i);break;case"Int32Array":a=new Int32Array(i);break;case"Int8Array":a=new Int8Array(i);break;case"Uint8Array":a=new Uint8Array(i);break;case"Uint16Array":a=new Uint16Array(i);break;case"Uint32Array":a=new Uint32Array(i);break;case"Uint8ClampedArray":a=new Uint8ClampedArray(i);break;default:a=new Uint32Array(i)}c({arr:a,meta:u.meta})}catch(i){s(i)}},n.onerror=()=>s(n.error)})}function se(e,t,r,c,s,o){let l=Array.from({length:r},()=>new Uint32Array(7).fill(0)),n=e[o].map((a=>d=>a+=d)(0));n[n.length-1]=1;let u=Array(r).fill(0),f=0,i=0;for(let a=0;a<n.length;a++)for(f=Math.max(f,n[a]*r),f=f-Math.floor(f)>Math.random()?Math.floor(f)+1:Math.floor(f);i<f;i++)u[i]=a+1;for(let a=0;a<7;a++)for(let d=1;d<=r;d++)c?l[d-1][a]=t[a][o]*Math.ceil(d/r*e[o].length):l[d-1][a]=t[a][o]*Math.ceil(u[d]);return s&&H(l),l}function ie(e,t,r,c,s,o){let l=Array.from({length:e},()=>new Uint32Array(9).fill(0)),n=t[o].map((a=>d=>a+=d)(0));n[n.length-1]=1;let u=Array(e).fill(0),f=0,i=0;for(let a=0;a<n.length;a++)for(f=Math.max(f,n[a]*e),f=f-Math.floor(f)>Math.random()?Math.floor(f)+1:Math.floor(f);i<f;i++)u[i]=a;for(let a=0;a<9;a++)for(let d=0;d<e;d++)c?l[d][a]=r[o][a][Math.ceil((d+1)/e*r[o][a].length)-1]:l[d][a]=r[o][a][u[d]];return s&&H(l),l}async function K(e,t,r,c,s,o,l,n,u){const f=e+l[u+(e=="Adv"?t.length:0)]+n.toString()+c.toString();let i=null;if(typeof indexedDB<"u"&&(i=await le(f)),i==null){let a;if(e=="Normal")a=se(t,r,c,n,!n,u);else if(e=="Adv")a=ie(c,s,o,n,!n,u);else throw new Error("Invalid hone type "+e);return typeof indexedDB<"u"&&ae(f,ne(a)),a}else return oe(i.arr,c)}async function Q(e,t,r,c,s,o,l,n,u,f,i,a=!1){let d=Array.from({length:r},()=>new Uint32Array(9).fill(0));for(let m=0;m<e.length;m++){let y=await K("Normal",e,t,r,n,u,i,a,m);for(let p=0;p<y.length;p++)for(let h=0;h<y[0].length;h++)d[p][h]+=y[p][h]}for(let m=0;m<n.length;m++){let y=await K("Adv",e,t,r,n,u,i,a,m);for(let p=0;p<y.length;p++)for(let h=0;h<y[0].length;h++)d[p][h]+=y[p][h]}let k=ee(c,s,o,l,f);for(let m=0;m<d.length;m++)d[m][3]+=k[0],d[m][6]+=k[1];return d}async function V(e,t,r,c,s,o,l,n,u,f,i,a){const d=await Q(r,c,e,s,o,l,n,u,f,i,a);if(t>0){const k=await Q(r,c,t,s,o,l,n,u,f,i,a,!0);return[d,k]}else return[d,[]]}async function ce(e,t,r,c,s,o,l,n,u,f,i,a,d,k,m,y){let[p,h,b,w,g]=R(e,t,r,c,u,f,a,d,k,m,y),[C,I]=await V(1e5,0,p,h,e,s,o,u,b,w,i,g),U=Array(l[0].length).fill(0),A=[];for(let T of[...Array(l[0].length).keys()])A[T]=Array(l.length).fill(0);for(let T of C)for(let[j,F]of l[0].entries()){let D=!1;for(let v of[...Array(l.length).keys()])l[v][j]<T[v]&&(D=!0,A[j][v]++);D||(U[j]+=1/C.length)}let x=[];for(let[T,j]of A.entries()){let F=[...Array(j.length).keys()].sort((S,B)=>j[B]-j[S]),D=[],v=!1;for(let S of F){let B=$(j[S]/C.length);(Number(B)>=.1||!v)&&D.push(n[S]+"("+B.toString()+"%)"),v=!0}Math.max(...j)==0?x.push("None"):x.push(D.join(`
`))}return[U,x]}function X(e,t){const r=e.length,c=t.length;if(r===0||c===0)return new Array(c).fill(0);const s=new Uint32Array(c);for(let o=0;o<r;o++){const l=e[o],n=l[0],u=l[1],f=l[2],i=l[3],a=l[4],d=l[5],k=l[6];for(let m=0;m<c;m++){const y=t[m];(n>y[0]||u>y[1]||f>y[2]||i>y[3]||a>y[4]||d>y[5]||k>y[6])&&s[m]++}}return Array.from(s)}async function fe(e,t,r,c,s,o,l,n,u,f,i,a,d,k,m){let[h,b,w,g,C]=R(e,t,r,c,n,u,i,a,d,k,m),[I,U]=await V(5e4,1e3,h,b,e,s,o,n,w,g,f,C),A=X(I,U);const x=I.length,T=Math.floor((1-l)*x),j=I[0].length,F=A.map(_=>Math.abs(_-T)),D=F.map((_,N)=>N).sort((_,N)=>F[_]===F[N]?_-N:F[_]-F[N]),v=U[D[0]];let S=[v];for(let _=0;_<h.length;_++){let N=v.slice(),J=v.slice(),L=[Array(h.length).keys()];L.splice(_,1),P(N,b,_),P(J,b,_,-1),S.push(N.slice()),S.push(J.slice());for(let Z=1;Z<h.length-1;Z++){let q=Math.floor(Math.random()*L.length);P(N,b,q),P(J,b,q,-1),L.splice(q,1),S.push(N.slice()),S.push(J.slice())}}let B=X(I,S);const z=B.map(_=>Math.abs(_-T)),Y=z.map((_,N)=>N).sort((_,N)=>z[_]===z[N]?_-N:z[_]-z[N]);let W=Array(j+1).fill(0);for(let _=0;_<j;_++)W[_]+=S[Y[0]][_];return W[j]=((1-B[Y[0]]/I.length)*100).toFixed(4),W}async function he(e){const t=e.normal_hone_ticks,r=e.adv_hone_ticks,c=e.budget,o=await(await fetch("/Honing-Forecast/data.json")).text(),{normal_hone_chances:l,normal_hone_weapon_cost:n,normal_hone_armor_cost:u,normal_hone_weapon_unlock:f,normal_hone_armor_unlock:i,adv_hone_cost:a,adv_hone_unlock:d,adv_data_10_20_juice:k,adv_data_30_40_juice:m,adv_data_10_20:y,adv_data_30_40:p}=JSON.parse(o),[h,b]=await ce(E(t),l,n,u,f,i,Array.from(O,C=>[Number(c[C])]),O,E(r),a,d,k,m,y,p,"No juice");let w=(h[0]*100).toFixed(2),g=b[0];return{chance:w,reason:g}}async function ue(e){const t=e.normal_hone_ticks,r=e.adv_hone_ticks,c=e.desired_chance,s=e.adv_hone_strategy,l=await(await fetch("/Honing-Forecast/data.json")).text(),{normal_hone_chances:n,normal_hone_weapon_cost:u,normal_hone_armor_cost:f,normal_hone_weapon_unlock:i,normal_hone_armor_unlock:a,adv_hone_cost:d,adv_hone_unlock:k,adv_data_10_20_juice:m,adv_data_30_40_juice:y,adv_data_10_20:p,adv_data_30_40:h}=JSON.parse(l),b=await fe(E(t),n,u,f,i,a,Number(c)/100,E(r),d,k,m,y,p,h,s),w=O.concat(["Red juice","Blue juice","Est. Probability"]);return Object.fromEntries(w.map((g,C)=>[g,b[C]]))}self.addEventListener("message",async e=>{const t=e.data;let r=Date.now();const{id:c,payload:s,which_one:o}=t;M(o=="CostToChance"||o=="ChanceToCost");let l;o=="CostToChance"?l=await he(s):o=="ChanceToCost"&&(l=await ue(s)),l.run_time=((Date.now()-r)/1e3).toFixed(2),self.postMessage({type:"result",id:c,result:l})})})();
