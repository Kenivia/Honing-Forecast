(function(){"use strict";function B(e){let t=Array.from({length:2},()=>new Array(e[0].length).fill(0));for(let r=0;r<e[0].length;r++)t[0][r]=(e[0][r]?1:0)+(e[1][r]?1:0)+(e[2][r]?1:0)+(e[3][r]?1:0)+(e[4][r]?1:0),t[1][r]=e[5][r]?1:0;return t}function G(e){let t=e.length;for(;t!=0;){let r=Math.floor(Math.random()*t);t--,[e[t],e[r]]=[e[r],e[t]]}}function k(e){if(!e)throw"Assertion failed"}function P(e,t,r,i=1){for(var a=Math.min(e.length,t.length),n=a;n--;)e[n]=Number(e[n])+Number(t[n][r])*i;return e}function $(e){e*=100;let t=0;for(;;){if(e>=1/10**t)return e.toFixed(t);if(t>=4)return"0";t++}}function H(e,t){const r=e.length,i=t.length;if(r===0||i===0)return new Array(i).fill(0);const a=new Uint32Array(i);for(let n=0;n<r;n++){const o=e[n],s=o[0],y=o[1],c=o[2],f=o[3],l=o[4],h=o[5],w=o[6];for(let m=0;m<i;m++){const _=t[m];(s>_[0]||y>_[1]||c>_[2]||f>_[3]||l>_[4]||h>_[5]||w>_[6])&&a[m]++}}return Array.from(a)}function ee(e,t,r,i=null,a=null){let n=0,o=0;for(const[s,y]of t.entries())for(const[c,f]of y.entries())s==0&&(n+=e[1][c]*f),s==1&&(o+=e[1][c]*f);for(const[s,y]of r.entries())for(const[c,f]of y.entries())s==0&&(n+=e[0][c]*f),s==1&&(o+=e[0][c]*f);if(Array.isArray(a))for(const[s,y]of a.entries())for(const[c,f]of y.entries())c%2==1&&(s==0&&(n+=i[0][Math.floor((c-1)/2)]*f),s==1&&(o+=i[0][Math.floor((c-1)/2)]*f)),c%2==0&&(s==0&&(n+=i[1][Math.floor(c/2)]*f),s==1&&(o+=i[1][Math.floor(c/2)]*f));return[n,o]}function te(e,t=1,r=0,i=0){let a=[],n=0,o=e,s=0;for(;;){if(i<=0&&(r=0),o=e+Math.min(s,10)*e/10+r,i-=1,n>=1){o=1,a[s]=o;break}a[s]=o,s+=1,n+=46.51/100*o*t}return a}function re(e){let t=new Array(e.length),r=1;for(const[i,a]of e.entries())t[i]=r*a,r*=1-a;return t}function R(e,t,r,i,a,n,o,s,y,c,f){k(e.length==2),k(e[0].length==e[1].length),k(Math.max(...e[0])<=5),k(Math.min(...e[0])>=0),k(Math.max(...e[1])<=1),k(Math.min(...e[1])>=0);for(const u of e[0])k(Number.isInteger(u));for(const u of e[1])k(Number.isInteger(u));k(Math.max(...a[0])<=5),k(Math.min(...a[0])>=0),k(Math.max(...a[1])<=1),k(Math.min(...a[1])>=0);for(const u of a[0])k(Number.isInteger(u));for(const u of a[1])k(Number.isInteger(u));let l=t;for(const u of l)k(0<u&&u<=1);k(f=="Juice on grace"||f=="No juice");let h=[],w=[],m=Array.from({length:r.length},()=>new Array);for(let u=0;u<e.length;u++){let M=u==0?i:r,A=0;for(let p=0;p<e[u].length;){if(A>=e[u][p]){p++,A=0;continue}h.push("Normal"+(u==0?" Armor ":" Weapon ")+" +"+p.toString()+"#"+A.toString());let C=l[p],I=te(C),U=re(I);for(const b of[...Array(r.length).keys()])m[b].push(M[b][p]);w.push(U),A++}}let _=[],d=[];for(let u=0;u<a.length;u++){let M=0;for(let A=0;A<a[u].length;){if(M>=a[u][A]){A++,M=0;continue}h.push("Adv"+(u==0?" Armor ":" Weapon ")+" +"+(A*10).toString()+"#"+M.toString());let p;f=="Juice on grace"?p=A<=1?o:s:p=A<=1?y:c;let C=Array(p.length).fill(0),I=p.map(b=>b[2]).reduce((b,x)=>b+x,0),U=Array.from({length:9},()=>new Array(C.length).fill(0));for(let b=0;b<C.length;b++){C[b]=p[b][2]/I;for(let x=0;x<7;x++)U[x][b]=n[x][2*A+(1-u)]*p[b][0];for(let x=7;x<9;x++)U[x][b]=n[x][2*A+(1-u)]*p[b][1]*(f=="Juice on grace"?1:0)}d.push(C),_.push(U),M++}}return d.length==0&&(d=[]),_.length==0&&(_=[]),[w,m,d,_,h]}function ne(e){if(!e||e.length===0)return new Uint32Array(0);const t=e.length,r=e[0].length;for(let n=1;n<t;n++)if(e[n].length!==r)throw new Error("All rows must have the same length");const i=new Uint32Array(t*r);let a=0;for(let n=0;n<t;n++)i.set(e[n],a),a+=r;return i}function oe(e,t,r={zeroCopy:!0}){const i=r.zeroCopy!==void 0?r.zeroCopy:!0;if(!Number.isInteger(t)||t<0)throw new Error("n must be a non-negative integer");if(t===0)return[];const a=e instanceof Uint32Array?e:new Uint32Array(e);if(a.length%t!==0)throw new Error("flat.length must be divisible by n");const n=a.length/t,o=new Array(t);if(i)for(let s=0;s<t;s++)o[s]=a.subarray(s*n,(s+1)*n);else for(let s=0;s<t;s++){const y=new Uint32Array(n);y.set(a.subarray(s*n,(s+1)*n)),o[s]=y}return o}function K(e="my-cache-db",t=1){return new Promise((r,i)=>{const a=indexedDB.open(e,t);a.onupgradeneeded=n=>{const o=n.target.result;o.objectStoreNames.contains("computed")||o.createObjectStore("computed",{keyPath:"key"})},a.onsuccess=()=>r(a.result),a.onerror=()=>i(a.error)})}async function ae(e,t,r={},i="my-cache-db"){const a=await K(i);return new Promise((n,o)=>{const y=a.transaction("computed","readwrite").objectStore("computed"),c=new Blob([t.buffer],{type:"application/octet-stream"}),f={key:e,dtype:t.constructor.name,length:t.length,meta:r,blob:c},l=y.put(f);l.onsuccess=()=>n(!0),l.onerror=()=>o(l.error)})}async function le(e,t="my-cache-db"){const r=await K(t);return new Promise((i,a)=>{const s=r.transaction("computed","readonly").objectStore("computed").get(e);s.onsuccess=async()=>{const y=s.result;if(!y)return i(null);const c=y.blob;try{const f=await c.arrayBuffer();let l;switch(y.dtype){case"Float32Array":l=new Float32Array(f);break;case"Float64Array":l=new Float64Array(f);break;case"Int16Array":l=new Int16Array(f);break;case"Int32Array":l=new Int32Array(f);break;case"Int8Array":l=new Int8Array(f);break;case"Uint8Array":l=new Uint8Array(f);break;case"Uint16Array":l=new Uint16Array(f);break;case"Uint32Array":l=new Uint32Array(f);break;case"Uint8ClampedArray":l=new Uint8ClampedArray(f);break;default:l=new Uint32Array(f)}i({arr:l,meta:y.meta})}catch(f){a(f)}},s.onerror=()=>a(s.error)})}function se(e,t,r,i,a,n){let o=Array.from({length:r},()=>new Uint32Array(7).fill(0)),s=e[n].map((l=>h=>l+=h)(0));s[s.length-1]=1;let y=Array(r).fill(0),c=0,f=0;for(let l=0;l<s.length;l++)for(c=Math.max(c,s[l]*r),c=c-Math.floor(c)>Math.random()?Math.floor(c)+1:Math.floor(c);f<c;f++)y[f]=l+1;for(let l=0;l<7;l++)for(let h=1;h<=r;h++)i?o[h-1][l]=t[l][n]*Math.ceil(h/r*e[n].length):o[h-1][l]=t[l][n]*Math.ceil(y[h]);return a&&G(o),o}function ie(e,t,r,i,a,n){let o=Array.from({length:e},()=>new Uint32Array(9).fill(0)),s=t[n].map((l=>h=>l+=h)(0));s[s.length-1]=1;let y=Array(e).fill(0),c=0,f=0;for(let l=0;l<s.length;l++)for(c=Math.max(c,s[l]*e),c=c-Math.floor(c)>Math.random()?Math.floor(c)+1:Math.floor(c);f<c;f++)y[f]=l;for(let l=0;l<9;l++)for(let h=0;h<e;h++)i?o[h][l]=r[n][l][Math.ceil((h+1)/e*r[n][l].length)-1]:o[h][l]=r[n][l][y[h]];return a&&G(o),o}async function Q(e,t,r,i,a,n,o,s,y,c,f,l,h,w){const m=e+l[w+(e=="Adv"?t.length:0)]+h.toString()+i.toString(),_=await le(m);if(_==null){let d;if(e=="Normal")d=se(t,r,i,h,!h,w);else if(e=="Adv")d=ie(i,y,c,h,!h,w);else throw new Error("Invalid hone type "+e);return ae(m,ne(d)),d}else return oe(_.arr,i)}async function V(e,t,r,i,a,n,o,s,y,c,f,l=!1){let h=Array.from({length:r},()=>new Uint32Array(9).fill(0));for(let m=0;m<e.length;m++){let _=await Q("Normal",e,t,r,i,a,n,o,s,y,c,f,l,m);for(let d=0;d<_.length;d++)for(let u=0;u<_[0].length;u++)h[d][u]+=_[d][u]}for(let m=0;m<s.length;m++){let _=await Q("Adv",e,t,r,i,a,n,o,s,y,c,f,l,m);for(let d=0;d<_.length;d++)for(let u=0;u<_[0].length;u++)h[d][u]+=_[d][u]}let w=ee(i,a,n,o,c);for(let m=0;m<h.length;m++)h[m][3]+=w[0],h[m][6]+=w[1];return h}async function X(e,t,r,i,a,n,o,s,y,c,f,l){const h=await V(r,i,e,a,n,o,s,y,c,f,l);if(t>0){const w=await V(r,i,t,a,n,o,s,y,c,f,l,!0);return[h,w]}else return[h,[]]}async function ce(e,t,r,i,a,n,o,s,y,c,f,l,h,w,m,_){let[d,u,M,A,p]=R(e,t,r,i,y,c,l,h,w,m,_),[C,I]=await X(1e5,0,d,u,e,a,n,y,M,A,f,p),U=Array(o[0].length).fill(0),b=[];for(let F of[...Array(o[0].length).keys()])b[F]=Array(o.length).fill(0);for(let F of C)for(let[j,T]of o[0].entries()){let z=!1;for(let v of[...Array(o.length).keys()])o[v][j]<F[v]&&(z=!0,b[j][v]++);z||(U[j]+=1/C.length)}let x=[];for(let[F,j]of b.entries()){let T=[...Array(j.length).keys()].sort((S,D)=>j[D]-j[S]),z=[],v=!1;for(let S of T){let D=$(j[S]/C.length);(Number(D)>=.1||!v)&&z.push(s[S]+"("+D.toString()+"%)"),v=!0}Math.max(...j)==0?x.push("None"):x.push(z.join(", "))}return[U,x]}async function fe(e,t,r,i,a,n,o,s,y,c,f,l,h,w,m){let[u,M,A,p,C]=R(e,t,r,i,s,y,f,l,h,w,m),[I,U]=await X(5e4,1e3,u,M,e,a,n,s,A,p,c,C),b=H(I,U);const x=I.length,F=Math.floor((1-o)*x),j=I[0].length,T=b.map(g=>Math.abs(g-F)),z=T.map((g,N)=>N).sort((g,N)=>T[g]===T[N]?g-N:T[g]-T[N]),v=U[z[0]];let S=[v];for(let g=0;g<u.length;g++){let N=v.slice(),J=v.slice(),L=[Array(u.length).keys()];L.splice(g,1),P(N,M,g),P(J,M,g,-1),S.push(N.slice()),S.push(J.slice());for(let Z=1;Z<u.length-1;Z++){let q=Math.floor(Math.random()*L.length);P(N,M,q),P(J,M,q,-1),L.splice(q,1),S.push(N.slice()),S.push(J.slice())}}let D=H(I,S);const E=D.map(g=>Math.abs(g-F)),Y=E.map((g,N)=>N).sort((g,N)=>E[g]===E[N]?g-N:E[g]-E[N]);let W=Array(j+1).fill(0);for(let g=0;g<j;g++)W[g]+=S[Y[0]][g];return W[j]=((1-D[Y[0]]/I.length)*100).toFixed(4),W}const O=["Red","Blue","Leaps","Shards","Oreha","Gold","Silver(WIP)"];async function he(e){const t=e.normal_hone_ticks,r=e.adv_hone_ticks,i=e.budget,n=await(await fetch("/Honing-forecast/data.json")).text(),{normal_hone_chances:o,normal_hone_weapon_cost:s,normal_hone_armor_cost:y,normal_hone_weapon_unlock:c,normal_hone_armor_unlock:f,adv_hone_cost:l,adv_hone_unlock:h,adv_data_10_20_juice:w,adv_data_30_40_juice:m,adv_data_10_20:_,adv_data_30_40:d}=JSON.parse(n),[u,M]=await ce(B(t),o,s,y,c,f,Array.from(O,C=>[Number(i[C])]),O,B(r),l,h,w,m,_,d,"No juice");let A=(u[0]*100).toFixed(2),p=M[0];return{chance:A,reason:p}}async function ue(e){const t=e.normal_hone_ticks,r=e.adv_hone_ticks,i=e.desired_chance,a=e.adv_hone_strategy,o=await(await fetch("/Honing-forecast/data.json")).text(),{normal_hone_chances:s,normal_hone_weapon_cost:y,normal_hone_armor_cost:c,normal_hone_weapon_unlock:f,normal_hone_armor_unlock:l,adv_hone_cost:h,adv_hone_unlock:w,adv_data_10_20_juice:m,adv_data_30_40_juice:_,adv_data_10_20:d,adv_data_30_40:u}=JSON.parse(o),M=await fe(B(t),s,y,c,f,l,Number(i)/100,B(r),h,w,m,_,d,u,a),A=O.concat(["Red juice","Blue juice","Est. Probability"]);return Object.fromEntries(A.map((p,C)=>[p,M[C]]))}self.addEventListener("message",async e=>{const t=e.data;let r=Date.now();const{id:i,payload:a,which_one:n}=t;k(n=="CostToChance"||n=="ChanceToCost");let o;n=="CostToChance"?o=await he(a):n=="ChanceToCost"&&(o=await ue(a)),o.run_time=((Date.now()-r)/1e3).toFixed(2),self.postMessage({type:"result",id:i,result:o})})})();
